<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="mobile.css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="jquery.ba-bbq.js"></script>
  <script type="text/javascript">
  function api_url(method, query) {
    return "http://openstates.sunlightlabs.com/api/v1/" + method + "/?" + query + "&apikey=sunlight9";
  }
  
  function load_legislators(state, callback) {    
    var legs = JSON.parse(localStorage.getItem("leg_list:" + state));
    if (!legs) {
      $.ajax({
        url: api_url("legislators", "state=" + state),
        dataType: 'jsonp',
        success: function (data) {
          localStorage.setItem("leg_list:" + state, JSON.stringify(data));
          load_legislators(state, callback);
        }});
      return;
    }
        
    for (var i in legs) {
      leg = legs[i];
      if (!leg.photo_url) {
        leg.photo_url = 'no_photo_male.png';
      }
      $("#legs").append('<li><a href="#_leg_' + leg['id'] + '"><img class="leg_thumb" src="' + leg.photo_url + '" /> ' + leg['full_name'] + '</a></li>');
    }
    callback();
  }
  
  function show_legislator(id, callback) {
    var leg = JSON.parse(localStorage.getItem(id));
    if (!leg) {
      $.ajax({
        url: api_url("legislators/" + id),
        dataType: 'jsonp',
        success: function (data) {
          localStorage.setItem(id, JSON.stringify(data));
          show_legislator(id, callback);
        }
      });
      return;
    }

    $("#leg_img").attr('src', leg.photo_url);
    $("#leg_name").text(leg.full_name);
    
    var role = leg.roles[0];
    
    $("#leg_party").text(role.party);
    $("#leg_chamber").text(role.chamber);
    $("#leg_district").text(role.district);
    callback();
  }
  
  $(window).bind('hashchange', function(e) {
    var loc = location.hash.replace("#_", "#");
    
    if (loc == "" || loc == "#") {
      loc = '#nav';
    }
    
    if (loc == '#legs') {
      load_legislators("tx", function() {
        $("#leg_link").focus();
        $("#nav").hide('slow');
        $("#leg_info").hide('slow');
        $(loc).show();
      });
    } else if (loc.match(/^#leg_.*/)) {
      var id = loc.substr(5);
      show_legislator(id, function() {
        $("#legs").hide('slow');
        $("#leg_info").show();
      });
    } else {
      $("#legs").hide('slow');
      $("#leg_info").hide('slow');
      $(loc).show();
    }
  });
  
  $(window).trigger('hashchange');
  </script>
  <meta name="viewport" content="user-scalable=no, width=device-width" />
  <title>Open State Project</title>
</head>
<body>
  <div id="header">
    <h1><a href="">Open State Project</a></h1>
  </div>
  <div id="content">
    <ul id="nav">
      <li><a id="leg_link" href="#_legs">Legislators</a></li>
      <li><a href="">Bills</a></li>
    </ul>

    <ul id="legs" style="display:none;">
    </ul>
    
    <div id="leg_info" class="leg_info" style="display: none;">
      <img id="leg_img" src="no_photo_male.png" />
      <div>
        <div><span class="leg_label">Name:</span> <span id="leg_name"></span></div>
        <div><span class="leg_label">Party:</span> <span id="leg_party"></span></div>
        <div><span class="leg_label">Chamber:</span> <span id="leg_chamber"></span></div>
        <div><span class="leg_label">District:</span> <span id="leg_district"></span></div>
      </div>
    </div>
  </div>
</body>
</html>